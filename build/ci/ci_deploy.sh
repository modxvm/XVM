#!/bin/bash

# XVM Team (c) https://modxvm.com 2014-2019
# XVM nightly build system

CURRENT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$CURRENT_PATH"
export XVMBUILD_ROOT_PATH="$CURRENT_PATH/../.."

source /var/xvm/ci_config.sh
source "$XVMBUILD_ROOT_PATH/build/xvm-build.conf"
source "$XVMBUILD_ROOT_PATH/build_lib/library.sh"

pack_xvm(){
    echo ""
    echo "Packing build"

    git_get_repostats "$XVMBUILD_ROOT_PATH"

    echo "$XVMBUILD_XVM_VERSION" >> "$XVMBUILD_ROOT_PATH"/~output/deploy/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    echo "$REPOSITORY_COMMITS_NUMBER" >> "$XVMBUILD_ROOT_PATH"/~output/deploy/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    echo "$REPOSITORY_HASH" >> "$XVMBUILD_ROOT_PATH"/~output/deploy/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    echo "$REPOSITORY_BRANCH" >> "$XVMBUILD_ROOT_PATH"/~output/deploy/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"

    pushd "$XVMBUILD_ROOT_PATH"/~output/deploy/ > /dev/null
    zip -9 -r -q xvm_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".zip ./
    rm "$XVMBUILD_ROOT_PATH"/~output/deploy/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    popd > /dev/null
}

pack_xfw(){
    echo ""
    echo "Packing XFW"

    git_get_repostats "$XVMBUILD_ROOT_PATH"

    echo "$XVMBUILD_XVM_VERSION" >> "$XVMBUILD_ROOT_PATH"/~output/xfw/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    echo "$REPOSITORY_COMMITS_NUMBER" >> "$XVMBUILD_ROOT_PATH"/~output/xfw/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    echo "$REPOSITORY_HASH" >> "$XVMBUILD_ROOT_PATH"/~output/xfw/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    echo "$REPOSITORY_BRANCH" >> "$XVMBUILD_ROOT_PATH"/~output/xfw/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"

    pushd "$XVMBUILD_ROOT_PATH"/~output/xfw/ > /dev/null
    zip -9 -r -q xfw_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".zip ./
    rm "$XVMBUILD_ROOT_PATH"/~output/xfw/"${XVMBUILD_XVM_VERSION}_${REPOSITORY_COMMITS_NUMBER}"
    popd > /dev/null
}


deploy(){
    echo ""
    echo "Deploying XVM"

    git_get_repostats "$XVMBUILD_ROOT_PATH"

    mkdir -p "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/

    mv -f "$XVMBUILD_ROOT_PATH"/~output/deploy/xvm_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".zip "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/

    cp -f "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".zip "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_latest.zip

    echo "$XVMBUILD_XVM_VERSION_$REPOSITORY_COMMITS_NUMBER" > "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_revision.txt
    echo $REPOSITORY_HASH > "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_hash.txt
    echo $REPOSITORY_BRANCH > "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_branch.txt
    echo $REPOSITORY_COMMITS_NUMBER > "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_commits.txt

    echo "$XVMBUILD_XVM_VERSION" > "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xvm_version.txt
    echo "$XVMBUILD_WOT_VERSION" > "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/wot_version.txt


    #XFW
    mv -f "$XVMBUILD_ROOT_PATH"/~output/xfw/xfw_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".zip "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/
    cp -f "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xfw_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".zip "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/xfw_latest.zip

    #INSTALLER
    mv -f "$XVMBUILD_ROOT_PATH"/~output/installer/xvm_"$XVMBUILD_XVM_VERSION"_"$REPOSITORY_COMMITS_NUMBER"_"$REPOSITORY_BRANCH"_"$REPOSITORY_HASH".exe "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/
    mv -f "$XVMBUILD_ROOT_PATH"/~output/installer/xvm_latest_"$REPOSITORY_BRANCH".exe "$XVMBUILD_OUTPUT_PATH"/"$REPOSITORY_BRANCH"/
}

pack_xvm
pack_xfw

deploy

clean_repodir
